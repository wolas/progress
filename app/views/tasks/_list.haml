#task_list
  - exclude_completed ||= false
  - completed, open  = tasks.partition {|task| task.completed? }
  - late, upcoming = open.partition {|task| task.late? }
  - task_list = [[:late, late], [:upcoming, upcoming], ]
  - task_list << [:completed, completed] unless exclude_completed
  - task_list.each do |type, list|

    - unless list.empty?
      %div{:class => "task_list #{type}"}
        %div{:class => "task_list_header header_#{type}"}= type.to_s.capitalize

        - list.reverse.each do |task|
          %div{:class => "task_list_item #{type}", :id => "task_item_#{task.id}"}

            %div{:class => "list_item_date #{type}"}
              = task.end_date.to_s(:long)
              - if task.open?
                - if task.days_remaining > 1
                  == (#{task.days_remaining} days away)
                - else
                  == (#{task.days_remaining.abs} days ago)
            \-
            .task_users
              - if task.users.empty?
                %span{:style => 'color:red;'}Not assigned
              - else
                = task.users.map{ |user| link_to user.name, user }.join(', ')

            .task_name
              - form_for task do |f|
                = f.check_box :completed
                %span{:style => 'color: #000;font-weight: normal;'}
                  - project = task.project
                  ==(#{link_to project.name, project}#{" for #{project.client.name}" if project.client})
                = link_to task.name, project_task_path(task.project, task), :style => 'color: #000;'
                %span{:style => "font-size: .6em; float: right; color:##{task.priority_colour};"}= task.priority
              = observe_form "edit_task_#{task.id}", :frequency => 0.25, :url => {:controller => 'tasks', :action => 'update', :id => task, :exclude_completed => exclude_completed, :tasks => tasks.map(&:id)}, :update => "task_list", :complete => update_page {|p| p[:"task_item_#{task.id}"].visual_effect :highlight }

      %br
